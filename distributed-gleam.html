<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-04-30 Sun 23:24 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gleam OTP Design Principles User's Guide</title>
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" href="tufte.css" type="text/css" />
<meta http-equiv="Content-Security-Policy"  content="default-src 'self'; img-src https://*; child-src 'none';">
</head>
<body>
<div id="content" class="content">
<h1 class="title">Gleam OTP Design Principles User's Guide</h1>
<p>
This document is a work in progress and will be updated as time permits.
</p>

<div id="outline-container-org67ee3c9" class="outline-2">
<h2 id="org67ee3c9">Overview</h2>
<div class="outline-text-2" id="text-org67ee3c9">
<p>
The OTP design principles define how to structure Gleam code in terms of processes and modules.
</p>
</div>

<div id="outline-container-org3ca4ec3" class="outline-3">
<h3 id="org3ca4ec3">Supervisor Tree</h3>
<div class="outline-text-3" id="text-org3ca4ec3">
<p>
A fundamental idea of most BEAM based language is the ability to supervise a process, and be notified of its failure.
This supervisory idea has roots in the erlang history and has become a well accepted method to deal with process failure.
</p>

<p>
There can be a heirachy of workers and supervisors, otherwise known as "the supervision tree".
</p>

<p>
Workers are processes that perform computations, that is they have work to do.
</p>

<ul class="org-ul">
<li>A supervisor can monitor the behaviour of workers.</li>
<li>A supervisor can restart aworker if something goes wrong.</li>
<li>A worker can notify a superivsor if something goes wrong.</li>
<li>A supervisor has different modes of dealing with worker failure.</li>
</ul>

<p>
Designing software that uses the supervision tree pattern  can allow a developer to create highly resiliant software.
</p>

<p>
In the following figure, square boxes represents supervisors and circles represent workers:
</p>


<div id="org579bf37" class="figure">
<p><img src="supervisors_and_processes.png" alt="supervisors_and_processes.png" />
</p>
</div>


<p>
Supervisors can supervise workers, and supervisors can supervise supervisors.
</p>
</div>
</div>

<div id="outline-container-orge93bbbd" class="outline-3">
<h3 id="orge93bbbd">Simple Processes example.</h3>
<div class="outline-text-3" id="text-orge93bbbd">
<p>
Before understanding the worker/supervisor implementation,  We should create a basic example
of starting a 'process' and sending messages to it.
</p>

<p>
A process is not a OS level process, it is a 'thread' running within the single <a href="https://www.erlang.org/blog/a-brief-beam-primer/">BEAM</a>.
virtual machine process. It doesn't come with the memory use and synchronization requirements that
traditional operating sytem thread or processes require.
</p>
</div>
</div>

<div id="outline-container-org829162b" class="outline-3">
<h3 id="org829162b">Starting a process.</h3>
<div class="outline-text-3" id="text-org829162b">
<p>
A process can be started with "process.start", see the following:
</p>

<pre class="example">
import gleam/erlang/process
...
let assert pid = process.start(running: start_process, linked: False)
</pre>

<p>
The first parameter is the function to run within the newly spawned process.  This function has
no arguements and returns no finished value, I like to use start_process to set the initial
state, then enter the main loop which will continue to deal with messages sent to this process.
</p>

<p>
The second parameter "linked: true", creates a "link" between two processes.
If either of the proccesses participating ink a link terminates, it will send an exit message to
the other participant.  The exit message will contain the reason of the terminated participant.
</p>

<p>
In this simple example, there is no need to know if a process has terminated as no action will be taken.  This
is not a supervisor.
</p>
</div>
</div>

<div id="outline-container-orgfdd60f1" class="outline-3">
<h3 id="orgfdd60f1">Sending messages</h3>
<div class="outline-text-3" id="text-orgfdd60f1">
<p>
Gleam’s process requires type safety for both processes and messages.  When sending messages between
processes, the first step is to have a 'subject' which references the spawned process.
</p>

<p>
You can do this with process.new_subject, that makes a subject based in the current process context.
</p>

<p>
Subject is an opaque type. An opaque type is a type where the constructors of that type arent
exposed to other modules that import the type.  You must use the "new_subject" call to create a new subject.
</p>

<p>
If the "new_subject" call is made in a different process, it would have different contents.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">my_subject</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_subject</span><span style="color: #FF4F00; background-color: #190700;">()</span>
</pre>
</div>

<p>
This reference is used to message the process that created the subject.  When a new process
is started, unless a subject is created in this new process context and the subject messaged
back to the parent process, the parent process will be unable to message the child.
</p>

<p>
As messages are strictly typed, you must create a Type that can encapsulate the needs of the
data being sent to the process, including subject data being sent between them.
</p>

<p>
The example below shows a types used in both sending and receiving from this newly spawned process.
</p>

<p>
ChannelResponse type (from the new process)
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">type</span> <span style="color: #FF7A00;">ChannelResponse</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF7A00;">ChildSubject</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Subject</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF7A00;">ChannelRequest</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF7A00;">Allocated</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00; font-style: italic;">id</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">Int</span><span style="color: #E14400; background-color: #190700;">)</span>   <span style="color: #D05010; font-style: italic;">// additional message that the process can respond with.</span>
  <span style="color: #FF7A00;">None</span>                 <span style="color: #D05010; font-style: italic;">// additional message that the process can respond with.</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>
</pre>
</div>

<p>
and the ChannelRequest type (to the new process)
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">type</span> <span style="color: #FF7A00;">ChannelRequest</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
   <span style="color: #FF7A00;">Allocate</span>
   <span style="color: #FF7A00;">Show</span>
   <span style="color: #FF7A00;">Free</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">ChannelResponse</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>
</pre>
</div>

<p>
As stated earlier, to be able to send to the process a subject in the new process context will need to be sent
to the parent process.
</p>

<p>
This message will need to be captured and used when making the request.  Below is a sequence diagram showing the basics of
starting processes.
</p>


<div id="orgca1b400" class="figure">
<p><img src="hello-uml.png" alt="hello-uml.png" />
</p>
</div>

<p>
After the "Child subject" has been received by the parent process, it can be used by the parent process
or passed to another, however the typed messages to the child must remain consistent. The "Send" channel
remains the same as long as the Child Process lives.
</p>

<p>
Messages can be set to a target subject with the 'process.send'.   The example allocate below is a simple
message of type "ChannelRequest" with no parameters.  More complex data can be passed with more complex Types
if required.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">Allocate</span><span style="color: #FF4F00; background-color: #190700;">)</span>
</pre>
</div>

<p>
Listed below is a module (derived from its filename called "aserver"  It is an example of a process sending a
message to another process using the method described above.
</p>

<p>
It contains some more advanced functionality that we will touch on later.
</p>

<div class="org-src-container">
<pre class="src src-gleam">
<span style="color: #FF5A00;">import</span> gleam/io
<span style="color: #FF5A00;">import</span> gleam/int
<span style="color: #FF5A00;">import</span> gleam/list
<span style="color: #FF5A00;">import</span> gleam/erlang/process<span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF4F00; background-color: #190700;">{</span><span style="color: #FF7A00;">Subject</span><span style="color: #FF4F00; background-color: #190700;">}</span>
<span style="color: #FF5A00;">import</span> gleam/result
<span style="color: #FF5A00;">import</span> gleam/function
<span style="color: #FF5A00;">import</span> gleam/iterator<span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF4F00; background-color: #190700;">{</span><span style="color: #F07010;">iterate</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #F07010;">take</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #F07010;">to_list</span><span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">type</span> <span style="color: #FF7A00;">ChannelResponse</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF7A00;">Allocated</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00; font-style: italic;">id</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">Int</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF7A00;">None</span>
  <span style="color: #FF7A00;">ChildSubject</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Subject</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF7A00;">ChannelRequest</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">type</span> <span style="color: #FF7A00;">ChannelRequest</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
   <span style="color: #FF7A00;">Allocate</span>
   <span style="color: #FF7A00;">Show</span>
   <span style="color: #FF7A00;">Free</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">ChannelResponse</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">alloc</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">mine</span> <span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
   <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">Allocate</span><span style="color: #E14400; background-color: #190700;">)</span>
   <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">allocation</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">receive</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">mine</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF3A00; font-style: italic;">within</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">1000</span><span style="color: #E14400; background-color: #190700;">)</span>
   <span style="color: #FF4A00;">allocation</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">free</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">mine</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">channel</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
   <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">Free</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">channel</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">show</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">mine</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
   <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">Show</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #D05010; font-style: italic;">// generate a list of 100 channels for init.</span>
<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">generate_channel_list</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
 <span style="color: #F07010;">iterate</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00;">1</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF5A00;">fn</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">n</span><span style="color: #D04000; background-color: #190700;">)</span> <span style="color: #D04000; background-color: #190700;">{</span> <span style="color: #FF3A00;">1</span><span style="color: #FF5A00;">+</span><span style="color: #FF4A00;">n</span> <span style="color: #D04000; background-color: #190700;">}</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">take</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00;">100</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">to_list</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">main</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">println</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF6A00;">"Hello from non_gen_server!"</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// similar to a channel between the process to start</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">my_subject</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_subject</span><span style="color: #E14400; background-color: #190700;">()</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">thing</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF5A00;">fn</span><span style="color: #E14400; background-color: #190700;">()</span> <span style="color: #E14400; background-color: #190700;">{</span> <span style="color: #F07010;">init</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">my_subject</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">}</span>

  <span style="color: #D05010; font-style: italic;">// why do i block here ?</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF4A00;">pid</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">start</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00; font-style: italic;">running</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">thing</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF3A00; font-style: italic;">linked</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">True</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// the channel from the child</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">ChildSubject</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">receive</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF3A00; font-style: italic;">within</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">100_000_000</span><span style="color: #E14400; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">result</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">unwrap</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">None</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// show the default channels.</span>
  <span style="color: #F07010;">show</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// get three channels.</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">channel1</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #F07010;">alloc</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">channel2</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #F07010;">alloc</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">channel3</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #F07010;">alloc</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// use the channels here.</span>
  <span style="color: #D05010; font-style: italic;">// use_channels</span><span style="color: #E14400; font-style: italic;">(</span><span style="color: #D05010; font-style: italic;">channel1, channel2, channel3</span><span style="color: #E14400; font-style: italic;">)</span>

  <span style="color: #D05010; font-style: italic;">// show the free channel list:</span>
  <span style="color: #F07010;">show</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// return the channels, as we're done with them.</span>
  <span style="color: #F07010;">free</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">channel1</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #F07010;">free</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">channel2</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #F07010;">free</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">channel3</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// show the newly used list, they will be out of order.</span>
  <span style="color: #F07010;">show</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">child_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">sleep_forever</span><span style="color: #D04000; background-color: #190700;">()</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">init</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">Subject</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">ChannelResponse</span><span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span>

  <span style="color: #D05010; font-style: italic;">// create another subject, that other processes can use</span>
  <span style="color: #D05010; font-style: italic;">// to address this new process.</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">my_subject</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_subject</span><span style="color: #E14400; background-color: #190700;">()</span>

  <span style="color: #D05010; font-style: italic;">// send the new subject back to the parent, using its subject.</span>
  <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">ChildSubject</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">my_subject</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// start the main process loop</span>
  <span style="color: #F07010;">loop</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #F07010;">generate_channel_list</span><span style="color: #D04000; background-color: #190700;">()</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">loop</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">Subject</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">ChannelRequest</span><span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">Subject</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">ChannelResponse</span><span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">channels</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">List</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Int</span><span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span>

  <span style="color: #D05010; font-style: italic;">// add a selector to listen from parent process.</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">sel</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_selector</span><span style="color: #E14400; background-color: #190700;">()</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">selecting</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00; font-style: italic;">for</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF3A00; font-style: italic;">mapping</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">function</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">identity</span> <span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// block forever on waiting for a message.</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">msg</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">select_forever</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">sel</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">new_channels</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>  <span style="color: #FF5A00;">case</span> <span style="color: #FF4A00;">msg</span> <span style="color: #E14400; background-color: #190700;">{</span>
     <span style="color: #FF7A00;">Allocate</span><span style="color: #D04000; background-color: #190700;">()</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #D04000; background-color: #190700;">{</span>
       <span style="color: #D05010; font-style: italic;">// choose the first value, return rest for new state</span>
       <span style="color: #FF5A00;">let</span> <span style="color: #AA3A00; background-color: #190700;">[</span><span style="color: #FF4A00;">next_available</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FFE0C0; background-color: #190700;">..</span> <span style="color: #FF4A00;">rest</span> <span style="color: #AA3A00; background-color: #190700;">]</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">channels</span>
       <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">Allocated</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">next_available</span><span style="color: #FF4F00; background-color: #190700;">)</span><span style="color: #AA3A00; background-color: #190700;">)</span>
       <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF6A00;">"allocating channel "</span> <span style="color: #FF5A00;">&lt;&gt;</span> <span style="color: #FF4A00;">int</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">to_string</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">next_available</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #AA3A00; background-color: #190700;">)</span>
       <span style="color: #FF4A00;">rest</span>
     <span style="color: #D04000; background-color: #190700;">}</span>
     <span style="color: #FF7A00;">Free</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">id</span><span style="color: #D04000; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #D04000; background-color: #190700;">{</span>
      <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Allocated</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">channel</span><span style="color: #AA3A00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">id</span>
      <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF6A00;">"Freeing channel: "</span> <span style="color: #FF5A00;">&lt;&gt;</span> <span style="color: #FF4A00;">int</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">to_string</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">channel</span><span style="color: #FF4F00; background-color: #190700;">)</span><span style="color: #AA3A00; background-color: #190700;">)</span>
      <span style="color: #FF4A00;">list</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">append</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4F00; background-color: #190700;">[</span><span style="color: #FF4A00;">channel</span><span style="color: #FF4F00; background-color: #190700;">]</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">channels</span><span style="color: #AA3A00; background-color: #190700;">)</span>
     <span style="color: #D04000; background-color: #190700;">}</span>
     <span style="color: #FF7A00;">Show</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #D04000; background-color: #190700;">{</span>
      <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF6A00;">"Available channels: !"</span><span style="color: #AA3A00; background-color: #190700;">)</span>
      <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">channels</span><span style="color: #AA3A00; background-color: #190700;">)</span>
      <span style="color: #FF4A00;">channels</span>
     <span style="color: #D04000; background-color: #190700;">}</span>
  <span style="color: #E14400; background-color: #190700;">}</span>

  <span style="color: #F07010;">loop</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">my_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">new_channels</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>
</pre>
</div>

<p>
This creates output like: (It will be slightly different on your system)
</p>

<pre class="example" id="org713d6d9">
TODO: generate example output code here.
</pre>
</div>
</div>

<div id="outline-container-org372a210" class="outline-3">
<h3 id="org372a210">Gleam OTP</h3>
<div class="outline-text-3" id="text-org372a210">
<p>
Gleam has its own library to simplify building programs using the actor model.  The current status of the gleam library
"experimental" however its been usable for some time.
</p>

<p>
Some of the OTP ideas from erlang are not implemented or do not cleanly map across to gleam, so they will be omitted.  If
they become feasible or sane at a later date, this document could be updated.
</p>
</div>
</div>

<div id="outline-container-orgafa1a8a" class="outline-3">
<h3 id="orgafa1a8a">Simple process example as an 'actor'</h3>
<div class="outline-text-3" id="text-orgafa1a8a">
<p>
Gleams actor implementation only runs on the erlang VM.  Actors take advantage of the underlying beam vm concurrency features
which allows communication via message passing of typed messages.
</p>

<p>
Each message is explicitly typed and tracable. The messages are received in a per-process mailbox and
stored in the order in which they are received.  Messages are stored in the mailbox until the process
reads them or terminates.
</p>

<p>
Erlangs tools such as the <a href="https://www.erlang.org/doc/apps/observer/observer_ug.html">Observer utility</a>, can be used see the mailbox of each process.
</p>

<p>
Below we show an example of a basic process being started.  It uses the similar mechanisms
of using subjects for communiction but uses the actor.Spec type to reduce the complexity to 'init' and 'loop'
functions.
</p>

<ul class="org-ul">
<li>The 'init' function sets up the state.</li>
<li>The 'loop' function handles messages being sent to the 'actor' process.</li>
</ul>

<p>
Once an actor.Spec has been created it can be started with the actor.start_spec function.
</p>

<p>
In this simple example, you might notice that the actor can not message the parent process in the 'loop'
function, however this could be added as 'state' during the init function.
</p>

<p>
The main process needs to 'sleep' while while waiting for the other processes to run.  Or the entire
process will be terminated early.
</p>

<p>
Use the following function, to sleep until the erlang vm is explicitly halted.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF7A00;">Ok</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">sleep_forever</span><span style="color: #E14400; background-color: #190700;">()</span><span style="color: #FF4F00; background-color: #190700;">)</span>
</pre>
</div>

<p>
Now for the meat.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">import</span> gleam/io
<span style="color: #FF5A00;">import</span> gleam/otp/actor
<span style="color: #FF5A00;">import</span> gleam/erlang/process

<span style="color: #FF5A00;">import</span> gleam/erlang

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">main</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FF4F00; background-color: #190700;">{</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">parent_subject</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_subject</span><span style="color: #E14400; background-color: #190700;">()</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">actor</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">start_spec</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Spec</span><span style="color: #D04000; background-color: #190700;">(</span>
      <span style="color: #FF3A00; font-style: italic;">init</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #AA3A00; background-color: #190700;">()</span> <span style="color: #AA3A00; background-color: #190700;">{</span>
        <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">final</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF6A00;">"message from init function"</span>
        <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">final</span><span style="color: #FF4F00; background-color: #190700;">)</span>
        <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Ready</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF3A00;">0</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_selector</span><span style="color: #E14400; background-color: #190700;">()</span><span style="color: #FF4F00; background-color: #190700;">)</span>
      <span style="color: #AA3A00; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
      <span style="color: #FF3A00; font-style: italic;">init_timeout</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">1000</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
      <span style="color: #FF3A00; font-style: italic;">loop</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">msg</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">state</span><span style="color: #AA3A00; background-color: #190700;">)</span> <span style="color: #AA3A00; background-color: #190700;">{</span>
        <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF6A00;">" IN CHILD: loop function triggered"</span><span style="color: #FF4F00; background-color: #190700;">)</span>
        <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF6A00;">" IN CHILD: Message from parent in loop: "</span> <span style="color: #FF5A00;">&lt;&gt;</span> <span style="color: #FF4A00;">msg</span><span style="color: #FF4F00; background-color: #190700;">)</span>
        <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Continue</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #FF4F00; background-color: #190700;">)</span>
      <span style="color: #AA3A00; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
    <span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">actor_subject</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">actor</span>

  <span style="color: #D05010; font-style: italic;">// get the message from the init function.</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">msg</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">receive</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">parent_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF3A00;">10</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF6A00;">"IN PARENT: "</span> <span style="color: #FF5A00;">&lt;&gt;</span> <span style="color: #FF4A00;">msg</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// send a message to the actor.</span>
  <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">actor_subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF6A00;">"Hello from parent"</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">actor_pid</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">subject_owner</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">actor_subject</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// terminate the actor, kill is required as not supervised.</span>
  <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">kill</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">actor_pid</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">println</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF6A00;">"Press Ctrl-c a enter to exit."</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">sleep_forever</span><span style="color: #D04000; background-color: #190700;">()</span><span style="color: #E14400; background-color: #190700;">)</span>

<span style="color: #FF4F00; background-color: #190700;">}</span>
</pre>
</div>


<p>
The output should be something like the following:
</p>

<pre class="example" id="org5e30f69">
"IN PARENT: message from init function"
" IN CHILD: loop function triggered"
" IN CHILD: Message from parent in loop: Hello from parent"
press enter to terminate the actor
Press Ctrl-c a enter to exit.
^C
BREAK: (a)bort (A)bort with dump (c)ontinue (p)roc info (i)nfo
       (l)oaded (v)ersion (k)ill (D)b-tables (d)istribution
a
</pre>

<p>
We can modify the example above to use erlangs built in <a href="https://www.erlang.org/doc/apps/observer/observer_ug.html">observer</a> utility to observe the process
being created and destroyed.
</p>

<p>
The erlang observer utility can be started as a foreign function and run in the gleam main thread
while the program is running to inspect system state.
</p>
</div>

<div id="outline-container-org2df6c36" class="outline-4">
<h4 id="org2df6c36">Terminating the actor.</h4>
<div class="outline-text-4" id="text-org2df6c36">
<p>
We can also explicitly terminate the actor, when we are done with it.  When an actor is unsupervised
it is considered to be standalone and 'kill' would be the only call that would terminate the process.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">actor_pid</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">subject_owner</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">actor_subject</span><span style="color: #FF4F00; background-color: #190700;">)</span>

<span style="color: #D05010; font-style: italic;">// must 'kill' the actor.</span>
<span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">kill</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">actor_pid</span><span style="color: #FF4F00; background-color: #190700;">)</span>
</pre>
</div>

<p>
The "kill" function sends a message.  If we modify the example we can see that after the kill signal has been
sent to the process, observer will show one less process in the list.
</p>
</div>
</div>
</div>

<div id="outline-container-org5d40fa8" class="outline-3">
<h3 id="org5d40fa8">The Worker</h3>
<div class="outline-text-3" id="text-org5d40fa8">
<p>
Gleam OTP formalises the "worker and supervisor" pattern.  Workers should always be children of a supervisor,
but supervisors can supervise other supervisors.
</p>

<p>
The worker function requirement takes a function which returns a result or an error, and returns a childspec.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #FF4A00;">worker</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">start</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #E14400; background-color: #190700;">(</span>a<span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF7A00;">Result</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Subject</span><span style="color: #D04000; background-color: #190700;">(</span>b<span style="color: #D04000; background-color: #190700;">)</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">StartError</span><span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF7A00;">ChildSpec</span><span style="color: #FF4F00; background-color: #190700;">(</span> b<span style="color: #FFE0C0; background-color: #190700;">,</span>  a<span style="color: #FFE0C0; background-color: #190700;">,</span>  a <span style="color: #FF4F00; background-color: #190700;">)</span>
</pre>
</div>

<pre class="example" id="org2c49c8c">
let actor =
  actor.start_spec(actor.Spec(
    init: fn() {
</pre>

<p>
The 'worker' function appears very similiar (but not exactly the same) as the actor example above.
</p>

<p>
NOTE i dont like the idea of 'child' name here, will find another.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">child</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
  <span style="color: #F07010;">worker</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF5A00;">fn</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">name</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #E14400; background-color: #190700;">{</span>
    <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">start_spec</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Spec</span><span style="color: #AA3A00; background-color: #190700;">(</span>
      <span style="color: #FF3A00; font-style: italic;">init</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
        <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">subject</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FFE0C0; background-color: #190700;">#</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">name</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">self</span><span style="color: #AA3A00; background-color: #190700;">()</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>
        <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Ready</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">name</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_selector</span><span style="color: #D04000; background-color: #190700;">()</span><span style="color: #E14400; background-color: #190700;">)</span>
      <span style="color: #FF4F00; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
      <span style="color: #FF3A00; font-style: italic;">init_timeout</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">10</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
      <span style="color: #FF3A00; font-style: italic;">loop</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #FF4F00; background-color: #190700;">(</span>_msg<span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">state</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span> <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Continue</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
    <span style="color: #AA3A00; background-color: #190700;">)</span><span style="color: #D04000; background-color: #190700;">)</span>
  <span style="color: #E14400; background-color: #190700;">}</span><span style="color: #FF4F00; background-color: #190700;">)</span>
</pre>
</div>

<p>
It took accepts sent messages to be handled in the loop function with initial state being setup
in the instance function.
</p>

<p>
This worker is not 'started' it merely exists as a specification to be used by a supervisor.
</p>

<p>
TODO: Integrate McNimbles suggestion about 'returning and the 3rd arg of ChildSpec', research and fill it in.
</p>
</div>
</div>

<div id="outline-container-org3e670d2" class="outline-3">
<h3 id="org3e670d2">The supervisor</h3>
<div class="outline-text-3" id="text-org3e670d2">
<p>
The supervisor is responsible for starting, stopping, and monitoring its child processes.
The basic idea of a supervisor is that it must keep its child processes alive by restarting them when necessary.
</p>

<p>
Gleam supervisors do not support the <a href="https://www.erlang.org/doc/design_principles/sup_princ.html#supervisor-flags">strategies</a> of the erlang, It defaults to 'one_for_one' as no strategy is
provided to the underlying erlang supervisor.
</p>

<p>
The children of a supervisor are defined as a list of worker specifications.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #FF4A00;">supervisor</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">start</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #E14400; background-color: #190700;">(</span>a<span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF7A00;">Result</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Subject</span><span style="color: #D04000; background-color: #190700;">(</span>b<span style="color: #D04000; background-color: #190700;">)</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">StartError</span><span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF7A00;">ChildSpec</span><span style="color: #FF4F00; background-color: #190700;">(</span> b<span style="color: #FFE0C0; background-color: #190700;">,</span>  a<span style="color: #FFE0C0; background-color: #190700;">,</span>  a <span style="color: #FF4F00; background-color: #190700;">)</span>
</pre>
</div>

<p>
And children can be added:
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #FF4A00;">add</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">children</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">Children</span><span style="color: #E14400; background-color: #190700;">(</span>a<span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">child_spec</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">ChildSpec</span><span style="color: #E14400; background-color: #190700;">(</span>b<span style="color: #FFE0C0; background-color: #190700;">,</span> a<span style="color: #FFE0C0; background-color: #190700;">,</span> c<span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF7A00;">Children</span><span style="color: #FF4F00; background-color: #190700;">(</span>c<span style="color: #FF4F00; background-color: #190700;">)</span>
</pre>
</div>

<p>
Add a child to the collection of children of the supervisor
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF4A00;">supervisor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">start_spec</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">supervisor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Spec</span><span style="color: #E14400; background-color: #190700;">(</span>
   <span style="color: #FF3A00; font-style: italic;">argument</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">1</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
   <span style="color: #FF3A00; font-style: italic;">frequency_period</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">1</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
   <span style="color: #FF3A00; font-style: italic;">max_frequency</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">5</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
   <span style="color: #FF3A00; font-style: italic;">init</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">children</span><span style="color: #D04000; background-color: #190700;">)</span> <span style="color: #D04000; background-color: #190700;">{</span>
     <span style="color: #FF4A00;">children</span>
     <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">add</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">child</span><span style="color: #AA3A00; background-color: #190700;">)</span>
     <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">add</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">child</span><span style="color: #AA3A00; background-color: #190700;">)</span>
     <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">add</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">child</span><span style="color: #AA3A00; background-color: #190700;">)</span>
   <span style="color: #D04000; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
 <span style="color: #E14400; background-color: #190700;">)</span><span style="color: #FF4F00; background-color: #190700;">)</span>

</pre>
</div>

<p>
If more than max_frequency number of restarts occur in the last frequency_period seconds, the supervisor terminates
all the child processes and then itself.
</p>

<p>
TODO: ensure i have the units right, not sure why gleam deviated from erlangs terms.
</p>

<p>
TODO: perhaps talk about tuning the intensitiy and period from <a href="https://www.erlang.org/doc/design_principles/sup_princ.html#tuning-the-intensity-and-period">here.</a>
</p>

<p>
References: gleam otp source for <a href="https://github.com/gleam-lang/otp/blob/main/src/gleam/otp/supervisor.gleam">supervisors</a>.
</p>
</div>
</div>

<div id="outline-container-org4dba262" class="outline-3">
<h3 id="org4dba262">Round the ring benchmark.</h3>
<div class="outline-text-3" id="text-org4dba262">
<p>
In his book Programming Erlang, Joe Armstrong asks:
</p>

<p>
Write a ring benchmark. Create N processes in a ring. Send a message round the ring M times so that a total of N * M messages get sent.
Time how long this takes for different values of N and M.
</p>

<p>
In this example the worker/supervisor requirements are not required.  It can be acheived with a ring of actors.  In this ring, each actor needs
to contain the subject of the next actor that it will need ot message.
</p>

<p>
Below is an example of this ring benchmark, using the glint library 0.12-rc3 library for parsing command line options.
</p>

<p>
Much like the previous example, when the main thread terminates, all the children processes will be terminated.
</p>

<p>
We had to add an external function to terminate the runtime.
</p>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">external</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">terminate</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF7A00;">Nil</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF6A00;">"erlang"</span> <span style="color: #FF6A00;">"halt"</span>
</pre>
</div>

<p>
Without explicit termination, we can't tell how long a runs as the user would need to interact with the process.
</p>

<p>
We run the benchmark with the process count of 100, with 200,000 iterations of the loop at the shell with the command:
</p>

<div class="org-src-container">
<pre class="src src-shell">$ gleam run -- --process-count=100 --loop=200000
</pre>
</div>

<div class="org-src-container">
<pre class="src src-gleam"><span style="color: #FF5A00;">import</span> gleam/io

<span style="color: #FF5A00;">import</span> gleam/otp/actor
<span style="color: #FF5A00;">import</span> gleam/iterator<span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF4F00; background-color: #190700;">{</span><span style="color: #F07010;">fold</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #F07010;">from_list</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #F07010;">take</span><span style="color: #FF4F00; background-color: #190700;">}</span>
<span style="color: #FF5A00;">import</span> gleam/erlang<span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF4F00; background-color: #190700;">{</span><span style="color: #F07010;">start_arguments</span><span style="color: #FF4F00; background-color: #190700;">}</span>
<span style="color: #FF5A00;">import</span> gleam/erlang/process<span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF4F00; background-color: #190700;">{</span><span style="color: #FF7A00;">Subject</span><span style="color: #FF4F00; background-color: #190700;">}</span>
<span style="color: #FF5A00;">import</span> glint<span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF4F00; background-color: #190700;">{</span><span style="color: #FF7A00;">CommandInput</span><span style="color: #FF4F00; background-color: #190700;">}</span>
<span style="color: #FF5A00;">import</span> glint/flag

<span style="color: #D05010; font-style: italic;">// Write a ring benchmark. Create N processes in a ring. Send a message round the ring M</span>
<span style="color: #D05010; font-style: italic;">// times so that a total of N * M messages get sent. Time how long this takes for different</span>
<span style="color: #D05010; font-style: italic;">// values of N and M.</span>

<span style="color: #D05010; font-style: italic;">// the key for the loop flag </span><span style="color: #FF4F00; font-style: italic;">(</span><span style="color: #D05010; font-style: italic;">M</span><span style="color: #FF4F00; font-style: italic;">)</span>
<span style="color: #FF5A00;">const</span> <span style="color: #FF3A00;">loop</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF6A00;">"loop"</span>

<span style="color: #D05010; font-style: italic;">// the key for the process-count flag </span><span style="color: #FF4F00; font-style: italic;">(</span><span style="color: #D05010; font-style: italic;">N</span><span style="color: #FF4F00; font-style: italic;">)</span>
<span style="color: #FF5A00;">const</span> <span style="color: #FF3A00;">process_count</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF6A00;">"process-count"</span>

<span style="color: #D05010; font-style: italic;">// terminate the vm,  i can't find a better way.</span>
<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">external</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">terminate</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF7A00;">Nil</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
  <span style="color: #FF6A00;">"erlang"</span> <span style="color: #FF6A00;">"halt"</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">type</span> <span style="color: #FF7A00;">Message</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF7A00;">Target</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Subject</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF7A00;">Message</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF7A00;">MsgNext</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Int</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF7A00;">NoTarget</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">type</span> <span style="color: #FF7A00;">SystemState</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF7A00;">NextInChain</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF7A00;">Subject</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF7A00;">Message</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF7A00;">None</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">handle_msg_next</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">count</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF5A00;">case</span> <span style="color: #FF4A00;">state</span> <span style="color: #E14400; background-color: #190700;">{</span>
    <span style="color: #FF7A00;">NextInChain</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #D04000; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #D04000; background-color: #190700;">{</span>
      <span style="color: #FF5A00;">case</span> <span style="color: #FF4A00;">count</span> <span style="color: #AA3A00; background-color: #190700;">{</span>
        <span style="color: #FF3A00;">0</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
          <span style="color: #F07010;">terminate</span><span style="color: #E14400; background-color: #190700;">()</span>
          <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Continue</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #E14400; background-color: #190700;">)</span>
        <span style="color: #FF4F00; background-color: #190700;">}</span>
        _anything_else <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
          <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">target</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">MsgNext</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">count</span> <span style="color: #FF5A00; background-color: #190700;">-</span> <span style="color: #FF3A00;">1</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>
          <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Continue</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #E14400; background-color: #190700;">)</span>
        <span style="color: #FF4F00; background-color: #190700;">}</span>
      <span style="color: #AA3A00; background-color: #190700;">}</span>
    <span style="color: #D04000; background-color: #190700;">}</span>
    <span style="color: #FF7A00;">None</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #D04000; background-color: #190700;">{</span>
      <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Continue</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #AA3A00; background-color: #190700;">)</span>
    <span style="color: #D04000; background-color: #190700;">}</span>
  <span style="color: #E14400; background-color: #190700;">}</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">make_actor</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">actor_spec</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Spec</span><span style="color: #E14400; background-color: #190700;">(</span>
      <span style="color: #FF3A00; font-style: italic;">init</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #D04000; background-color: #190700;">()</span> <span style="color: #D04000; background-color: #190700;">{</span> <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Ready</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF7A00;">None</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new_selector</span><span style="color: #FF4F00; background-color: #190700;">()</span><span style="color: #AA3A00; background-color: #190700;">)</span> <span style="color: #D04000; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
      <span style="color: #FF3A00; font-style: italic;">init_timeout</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF3A00;">1000</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
      <span style="color: #FF3A00; font-style: italic;">loop</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">msg</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">Message</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">state</span><span style="color: #D04000; background-color: #190700;">)</span> <span style="color: #D04000; background-color: #190700;">{</span>
        <span style="color: #FF5A00;">case</span> <span style="color: #FF4A00;">msg</span> <span style="color: #AA3A00; background-color: #190700;">{</span>
          <span style="color: #FF7A00;">Target</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">t</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
            <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">newstate</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF7A00;">NextInChain</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">t</span><span style="color: #E14400; background-color: #190700;">)</span>
            <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Continue</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">newstate</span><span style="color: #E14400; background-color: #190700;">)</span>
          <span style="color: #FF4F00; background-color: #190700;">}</span>
          <span style="color: #FF7A00;">MsgNext</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">count</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
            <span style="color: #F07010;">handle_msg_next</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">count</span><span style="color: #E14400; background-color: #190700;">)</span>
          <span style="color: #FF4F00; background-color: #190700;">}</span>
          <span style="color: #FF7A00;">NoTarget</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
            <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">Continue</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">state</span><span style="color: #E14400; background-color: #190700;">)</span>
          <span style="color: #FF4F00; background-color: #190700;">}</span>
        <span style="color: #AA3A00; background-color: #190700;">}</span>
      <span style="color: #D04000; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
    <span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">actor</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">actor</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">start_spec</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">actor_spec</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF4A00;">actor</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">pub</span> <span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">main</span><span style="color: #FF4F00; background-color: #190700;">()</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">loop_flag</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">I</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">default</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00;">10</span><span style="color: #E14400; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">description</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF6A00;">"Loop the ring n times."</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">process_count_flag</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #FF7A00;">I</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">default</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00;">1000</span><span style="color: #E14400; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">description</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF6A00;">"Create N processes in a ring"</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF4A00;">glint</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">new</span><span style="color: #E14400; background-color: #190700;">()</span>
  <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">glint</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">add</span><span style="color: #E14400; background-color: #190700;">(</span>
    <span style="color: #FF3A00; font-style: italic;">at</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #D04000; background-color: #190700;">[]</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
    <span style="color: #FF3A00; font-style: italic;">do</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">glint</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">command</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">build_args</span><span style="color: #D04000; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">glint</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">flag</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">loop</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">loop_flag</span><span style="color: #D04000; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">glint</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">flag</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">process_count</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">process_count_flag</span><span style="color: #D04000; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">glint</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">description</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF6A00;">"Runs Joe Armstrongs ring benchmark"</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
  <span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">glint</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">run_and_handle</span><span style="color: #E14400; background-color: #190700;">(</span>
    <span style="color: #F07010;">start_arguments</span><span style="color: #D04000; background-color: #190700;">()</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
    <span style="color: #FF5A00;">fn</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">res</span><span style="color: #D04000; background-color: #190700;">)</span> <span style="color: #D04000; background-color: #190700;">{</span>
      <span style="color: #FF5A00;">case</span> <span style="color: #FF4A00;">res</span> <span style="color: #AA3A00; background-color: #190700;">{</span>
        <span style="color: #FF7A00;">Ok</span><span style="color: #FF4F00; background-color: #190700;">(</span>_out<span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
          <span style="color: #D05010; font-style: italic;">// probably should have better error handling here.</span>
          <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">debug</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF6A00;">"looks good - OKAY"</span><span style="color: #E14400; background-color: #190700;">)</span>
        <span style="color: #FF4F00; background-color: #190700;">}</span>
        <span style="color: #FF7A00;">Error</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">err</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">-&gt;</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
          <span style="color: #FF4A00;">err</span>
        <span style="color: #FF4F00; background-color: #190700;">}</span>
      <span style="color: #AA3A00; background-color: #190700;">}</span>
      <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">io</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">println</span>
    <span style="color: #D04000; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
  <span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>

<span style="color: #FF5A00;">fn</span> <span style="color: #F07010;">build_args</span><span style="color: #FF4F00; background-color: #190700;">(</span><span style="color: #FF4A00;">input</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">CommandInput</span><span style="color: #FF4F00; background-color: #190700;">)</span> <span style="color: #FF4F00; background-color: #190700;">{</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">loop</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">get_int</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00; font-style: italic;">from</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">input</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">flags</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF3A00; font-style: italic;">for</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">loop</span><span style="color: #E14400; background-color: #190700;">)</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">process_count</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">flag</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">get_int</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF3A00; font-style: italic;">from</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">input</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">flags</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF3A00; font-style: italic;">for</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF4A00;">process_count</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// make 10 actors</span>
  <span style="color: #FF5A00;">let</span> <span style="color: #FF4A00;">actor_list</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">iterator</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">repeatedly</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF5A00;">fn</span><span style="color: #D04000; background-color: #190700;">()</span> <span style="color: #D04000; background-color: #190700;">{</span> <span style="color: #F07010;">make_actor</span><span style="color: #AA3A00; background-color: #190700;">()</span> <span style="color: #D04000; background-color: #190700;">}</span><span style="color: #E14400; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">take</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">process_count</span><span style="color: #E14400; background-color: #190700;">)</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">iterator</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">to_list</span><span style="color: #E14400; background-color: #190700;">()</span>

  <span style="color: #FF4A00;">actor_list</span>
  <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">from_list</span>
  <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">fold</span><span style="color: #E14400; background-color: #190700;">(</span>
    <span style="color: #FF3A00; font-style: italic;">from</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF7A00;">NoTarget</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
    <span style="color: #FF3A00; font-style: italic;">with</span><span style="color: #FFE0C0; background-color: #190700;">:</span> <span style="color: #FF5A00;">fn</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">prev</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">element</span><span style="color: #D04000; background-color: #190700;">)</span> <span style="color: #D04000; background-color: #190700;">{</span>
      <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">element</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF4A00;">prev</span><span style="color: #AA3A00; background-color: #190700;">)</span>
      <span style="color: #FF7A00;">Target</span><span style="color: #AA3A00; background-color: #190700;">(</span><span style="color: #FF4A00;">element</span><span style="color: #AA3A00; background-color: #190700;">)</span>
    <span style="color: #D04000; background-color: #190700;">}</span><span style="color: #FFE0C0; background-color: #190700;">,</span>
  <span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">last_actor</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">actor_list</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">from_list</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">iterator</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">last</span><span style="color: #E14400; background-color: #190700;">()</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">first_actor</span><span style="color: #E14400; background-color: #190700;">)</span> <span style="color: #FFE0C0; background-color: #190700;">=</span>
    <span style="color: #FF4A00;">actor_list</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #F07010;">from_list</span>
    <span style="color: #FF5A00;">|&gt;</span> <span style="color: #FF4A00;">iterator</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">first</span><span style="color: #E14400; background-color: #190700;">()</span>

  <span style="color: #D05010; font-style: italic;">// set the last actor to message the first.</span>
  <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">first_actor</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">Target</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">last_actor</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #D05010; font-style: italic;">// fire off the message to the ring.</span>
  <span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">send</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">last_actor</span><span style="color: #FFE0C0; background-color: #190700;">,</span> <span style="color: #FF7A00;">MsgNext</span><span style="color: #D04000; background-color: #190700;">(</span><span style="color: #FF4A00;">process_count</span> <span style="color: #FF5A00;">*</span> <span style="color: #FF4A00;">loop</span><span style="color: #D04000; background-color: #190700;">)</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF5A00;">let</span> <span style="color: #FF5A00;">assert</span> _discard <span style="color: #FFE0C0; background-color: #190700;">=</span> <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF4A00;">process</span><span style="color: #FFE0C0; background-color: #190700;">.</span><span style="color: #F07010; font-style: italic;">sleep_forever</span><span style="color: #D04000; background-color: #190700;">()</span><span style="color: #E14400; background-color: #190700;">)</span>

  <span style="color: #FF7A00;">Ok</span><span style="color: #E14400; background-color: #190700;">(</span><span style="color: #FF6A00;">"Ring Complete"</span><span style="color: #E14400; background-color: #190700;">)</span>
<span style="color: #FF4F00; background-color: #190700;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgea2d460" class="outline-2">
<h2 id="orgea2d460">Distribution</h2>
<div class="outline-text-2" id="text-orgea2d460">
<p>
A distributed Erlang system consists of a number of Erlang runtime systems communicating with each other.
Each such runtime system is called a node. Message passing between processes at different nodes, as well as
links and monitors are transparent when pids are used.
</p>

<p>
By default gleam is NOT started in a distributed node and is configured not to be able to interact with other
BEAM nodes.
</p>

<p>
When using un-secure distributed nodes, make sure that the network is configured to keep potential
attackers out. See the Using SSL for Erlang Distribution User's Guide for details on how to setup
a secure distributed node.
</p>
</div>


<div id="outline-container-org5505717" class="outline-3">
<h3 id="org5505717">Starting up nodes.</h3>
<div class="outline-text-3" id="text-org5505717">
<ul class="org-ul">
<li>mention that shortname or longname, not both.</li>

<li>epmd should be started.</li>

<li>panging a node.</li>
</ul>


<p>
Starting up nodes, firewall rules, mention the ports.
</p>
</div>
</div>

<div id="outline-container-orgd8e976e" class="outline-3">
<h3 id="orgd8e976e">Spawning a process on another node.</h3>
<div class="outline-text-3" id="text-orgd8e976e">
<p>
Demonstrate starting a process on another node.
</p>
</div>
</div>

<div id="outline-container-org8a9a0aa" class="outline-3">
<h3 id="org8a9a0aa">Finding processes on another node</h3>
<div class="outline-text-3" id="text-org8a9a0aa">
<p>
Demonstrate finding a process on another node.
</p>
</div>
</div>

<div id="outline-container-orgada14d2" class="outline-3">
<h3 id="orgada14d2">Gleam process registry ?</h3>
<div class="outline-text-3" id="text-orgada14d2">
<p>
This doesn't exist, should it? how do i find processes on another node.
</p>
</div>
</div>
</div>

<div id="outline-container-orgb043477" class="outline-2">
<h2 id="orgb043477">Resources:</h2>
<div class="outline-text-2" id="text-orgb043477">
<ul class="org-ul">
<li>Erlang design principals: <a href="https://www.erlang.org/doc/design_principles/users_guide.html">https://www.erlang.org/doc/design_principles/users_guide.html</a></li>
<li>McNimbles OTP demo: <a href="https://code-change.nl/gleam-blog/20230225-gleam-otp.html">https://code-change.nl/gleam-blog/20230225-gleam-otp.html</a></li>
<li>Gleam OTP on hex.pm <a href="https://hex.pm/packages/gleam_otp">https://hex.pm/packages/gleam_otp</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgff5f6e0" class="outline-2">
<h2 id="orgff5f6e0">Acknowledgements:</h2>
<div class="outline-text-2" id="text-orgff5f6e0">
<p>
Thanks to :
</p>
<ul class="org-ul">
<li>rawhat for helping out with debugging issues.</li>
<li>McNimble for multiple fixes and encouragement.</li>
</ul>
</div>
</div>
</div>
</body>
</html>